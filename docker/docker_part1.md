# 컨테이너와 Docker

## 개요

- 컨테이너
  - 호스트 OS상에 논리적인 구획(컨테이너)을 만들고, 애플리케이션을 작동시키기 위해 필요한 라이브러리나 애플리케이션 등을 하나로 모아, 별도의 서버인 것처럼 사용할 수 있께 만든 것.
  - 호스트 OS의 리소스를 논리적으로 분리시키고, 여러 개의 컨테이너가 공유하여 사용한다.
    - 보통 물리 서버 상에 설치한 호스트 OS의 경우 하나의 OS 상에서 움직이는 여러 애플리케이션은 똑같은 시스템 리소스를 사용한다.
    - 이때 작동하는 여러 애플리케이션은 데이터를 저장하는 디렉토리를 공유하고, 서버에 설정된 동일한 IP 주소로 통신을 한다.
    - 따라서 여러 애플리케이션에서 사용하고 있는 미들웨어나 라이브러리의 버전이 다른 경우에는 각 애플리케이션이 서로 영향을 받지 않도록 주의해야 한다.
    - 이에 반해 컨테이너 기술을 사용하면 OS나 디렉토리, IP 주소 등과 같은 시스템 자원을 마치 각 애플리케이션이 점유하고 있는 것처럼 보이게 할 수 있다.
  - 컨테이너는 오버헤드가 적기 때문에 가볍고 고속으로 작동하는 것이 특징이다.



- Dokcer 개요
  - 애플리케이션의 실행에 필요한 환경을 하나의 이미지로 모아두고, 그 이미지를 사용하여 다양한 환경에서 애플리케이션 실행 환경을 구축 및 운용하기 위한 플랫폼이다.
    - 내부에서 컨테이너 기술을 사용한다.
    - 오픈 소스다.
  - Docker를 사용하는 이유
    - 개발을 하다 보면 개발 환경, 테스트 환경에서는 정상적으로 동작하는데, 스테이징 환경(제품 환경에 배포하기 직전에 확인하는 테스트 환경), 제품 환경에서는 동작하지 않는 경우가 존재한다.
    - 위와 같은 현상의 원인에는 여러 가지가 있지만, 그 중 대표적인 것이 각 환경별로 인프라가 다르기 때문이다.
    - 도커는 애플리케이션 실행에 필요한 모든 인프라를 컨테이너로 모아 각 환경에서 해당 컨테이너를 사용함으로써 인프라가 달라서 발생하는 문제를 방지하는 데 목적이 있다.



- Docker의 기능
  - Docker 이미지
    - 애플리케이션의 실행에 필요한 파일들이 저장된 디렉토리.
    - 실행 환경에서 움직이는 컨테이너의 바탕이 된다.
    - Docker에서는 하나의 이미지에는 하나의 애플리케이션만 넣어 두고, 여러 개의 컨테이너를 조합하여 서비스를 구축하는 방법을 권장하고 있다.
    - Docker 이미지는 겹쳐서 사용이 가능하다. 예를 들어 OS용 이미지에 웹 애플리케이션용 이미지를 겹쳐서 다른 새로운 이미지를 만들 수 있다.
  - 이미지를 만드는 기능(Build)
    - 애플리케이션의 실행에 필요한 라이브러리, 미들웨어, OS나 네트워크 설정 등을 하나로 모아서 Docker 이미지를 만든다.
    - Docker 이미지는 실행 환경에서 움직이는 컨테이너의 바탕이 된다.
    - Docker의 이미지는 Docker의 명령을 사용하여 수동으로 만들 수도 있으며, Dockerfile이라는 설정 파일을 만들어 그것을 바탕으로 자동으로 이미지를 만들 수도 있다.
    - 지속적인 인티그레이션과 지속적 딜리버리의 관점에서 코드에 의한 인프라의 구성 관리를 생가갛면 Dockerfile을 사용하여 관리하는 것이 바람직하다.
  - Docker 이미지를 공유하는 기능(Ship)
    - Docker 이미지는 Docker 레지스트리에서 공유가 가능하다.
    - Docker의 공식 레지시트리인 Docker Hub에서는 다양한 베이스 이미지들이 존재한다.
    - Docker Hub는 github이나 bitbucket과 연계하여 사용하는 것이 가능하다.
    - 예를 들어 깃헙 상에서 Dockerfile을 관리하고, 거기서 Docker 이미지를 자동으로 생성하여 Docker Hub에서 공개하는 것도 가능(Automated Build)하다.
  - Docker 컨테이너를 작동시키는 기능
    - Docker는 Linux 상에서 컨테이너 단위로 서버 기능을 작동시킨다.
    - 이 컨테이너의 바탕이 되는 것이 Docker 이미지로, Docker 이미지만 있으면 Docker가 설치된 환경이라면 어디서든 컨테이너를 작동시킬 수 있다.
    - Docker 이미지를 가지고 여러 개의 컨테이너를 가동시킬 수도 있다.



- Docker 컴포넌트
  - Docker는 아래와 같은 컴포넌트로 구성되어 있다.
    - 핵심 기능이 되는 Docker engine을 중심으로 컴포넌트를 조합하여 애플리케이션 실행 환경을 구축한다.
  - Docker Engine(Docker의 핵심 기능)
    - Docker 이미지를 생성하고 컨테이너를 기동시키기 위한 Docker의 핵심 기능.
    - Docker 명령의 실행이나 Dockerfile에 의한 이미지도 생성한다.
  - Docker Registry(이미지 공개 및 공유)
    - 컨테이너의 바탕이 되는 Docker 이미지를 공개 및 공유하기 위한 레지스트리 기능.
    - Docker의 공식 레지스트리 서비스인 Docker Hub도 이 Docker Registry를 사용하고 있다.
  - Docker Compose(컨테이너 일원 관리)
    - 여러 개의 컨테이너 구성 정보를 코드로 정의하고, 명령을 실행함으로써 애플리케이션의 실행 환경을 구성하는 컨테이너들을 일원 관리하기 위한 툴.
  - Docker Machine(Docker 실행 환경 구축)
    - 로컬 호스트용인 VirtualBox를 비롯하여 AWS EC2나 Azure와 같은 클라우드 환경에 Docker의 실행 환경을 명령으로 자동 생성하기 위한 툴이다.
  - Docker Swarm(클러스터 관리)
    - 여러 Docker 호스트를 클러스터화하기 위한 툴이다.
    - Docker Swarm에서는 클러스터를 관리하거나 API를 제공하는 역할은 Manager가, Docker 컨테이너를 실행하는 역할은 Node가 담당한다.
    - 오픈소스인 Kubernetes도 사용 가능하다.



## Docker의 작동 구조

- Docker는 리눅스 커널의 기술이 베이스로 되어 있다.



- 컨테이너를 구획화하는 장치(namespace)
  - 컨테이너라는 독립된 환경을 만들고, 그 컨테이너를 구획화하여 애플리케이션의 실행 환경을 만든다.
  - 컨테이너를 구획화하는 기술은 리눅스 커널의 namespace라는 기능을 사용한다.
    - namespace란 한 덩어리의 데이터에 이름을 붙여 분할함으로써 충돌 가능성을 줄이고, 쉽게 참조할 수 있게 하는 개념이다.
    - 이름과 연결된 실체는 그 이름이 어떤 namespace에 속해 있는지 고유하게 정해진다.
    - 따라서 namespace가 다르면 동일한 이름이라도 다른 실체로 처리된다.
  - 리눅스 커널의 namespace 기능은 리눅스의 오브젝트에 이름을 붙임으로써 다음과 같은 6개의 독립된 환경을 구축할 수 있다.
    - PID namespace: PID란 리눅스에서 각 프로세스에 할당된 고유한 ID를 말한다. PID namespace는 PID와 프로세스를 격리시키며, namespace가 다른 프로세스끼리는 서로 엑세스 할 수 없다.
    - Network namespace: 네트워크 디바이스, IP 주소, 포트 번호, 라우팅 테이블, 필터링 테이블 등과 같은 네트워크 리소스를 격리된 namespace마다 독립적으로 가질 수 있다. 이 기능을 사용하면 호스트 OS 상에서 사용 중인 포트가 있더라도 컨테이너 안에서 동일한 번호의 포트를 사용할 수 있다.
    - UID namespace: UID(사용자 ID), GID(그룹 ID)를 namespace별로 독립적으로 가질 수 있다. namespace 안과 호스트 OS 상의 UID,GID가 서로 연결되어 namespace 안과 밖에서 서로 다른 UID,GID를 가질 수 있다.
    - MOUNT namespace: 리눅스에서 파일 시스템을 사용하기 위해서는 마운트가 필요하다. 마운트란 컴퓨터에 연결 된 기기나 기억 장치를 OS에 인식시켜 이용 가능한 상태로 만드는 것을 말한다. MOUNT namespace는 마운트 조작을 하면 namespace 안에 격리된 파일 시스템 트리를 만든다.
    - UTS namespace: namespace별로 호스트명이나 도메인명을 독자적으로 가질 수 있다.
    - IPC namespace:  프로세스 간의 통신(IPC) 오브젝트를 namespace별로 독립적으로 가질 수 있다.



- 릴리스 관리 장치(cgroups)

  - Docker에서는 물리 머신 상의 자원을 여러 컨테이너가 공유하여 작동한다.

    - 이 때 리눅스 커널의 기능인 control groups 기능을 사용하여 자원의 할당 등을 관리한다.

  - 리눅스에서는 프로그램을 프로세스로서 실행한다.

    - 프로세스는 하나 이상의 스레드 모음으로 움직인다.
    - cgroups는 프로세스와 스레드를 그룹화하여, 그 그룹 안에 존재하는 프로세스와 스레드에 대한 관리를 수행하기 위한 기능이다.
    - 컨테이너 안의 프로세스에 대해 자원을 제한함으로써 특정 컨테이너가 호스트 OS의 자원을 모두 사용해 버려서 동일한 호스트 OS 상에서 가동되는 다른 컨테이너에 영향을 주는 일을 막을 수 있다.

  - cgroups으로 관리할 수 있는 사항들

    | 항목    | 설명                             |
    | ------- | -------------------------------- |
    | cpu     | CPU 사용량 제한                  |
    | cpuacct | CPU 사용량 통계 정보 제공        |
    | cpuset  | CPU나 메모리 배치 제어           |
    | memory  | 메모리나 스왑 사용량 제한        |
    | devices | 디바이스에 대한 액세스 허가/거부 |
    | freezer | 그룹에 속한 프로세스 정지/재개   |
    | net_cls | 네트워크 제어 태그를 부가        |
    | blkio   | 블록 디바이스 입출력량 제어      |

  - cgroups는 계층 구조를 사용하여 프로세스를 그룹화형 관리할 수 있다.



- 네트워크 구성(가상 브리지/가상 NIC)
  - 리눅스는 도커를 설치하면 서버의 물리 NIC가 docker0라는 가상 브리지 네트워크로 연결된다.
    - docker0는 Docker를 실행시킨 후에 디폴트로 만들어진다.
    - Docker 컨테이너가 실행되면 컨테이너에 172.17.0.0/16이라는 서브넷 마스크를 가진 프라이빗 IP 주소가 eth0으로 자동으로 할당된다.
    - 이 가상 NIC는 OSI 참조 모델의 레이어 2인 가상 네트워크 인터페이스로, 페어인 NIC와 터널링 통신을 한다.
  - NAPT(Network Address Port Translation)
    - Docker 컨테이너와 외부 네트워크가 통신을 할 때는 가상 브리지 docker0와 호스트 OS의 물리 NIC에서 패킷을 전송하려는 장치가 필요하다.
    - Docker에서는 NAPT 기능을 사용하여 연결한다.
    - NAPT란 하나의 IP 주소를 여러 컴퓨터가 공유하는 기술로, IP 주소와 포트 번호를 변환하는 기능이다.
    - 프라이빗 IP 주소와 글로벌 IP 주소를 투과적으로 상호 변환하는 기술로, TCP/IP의 포트 번호까지 동적으로 변환하기 때문에 하나의 글로벌 IP 주소로 여러 대의 머신이 동시에 연결할 수 있다.
    - Docker에서는 NAPT에 리눅스의 iptables를 사용하고 있다.



- Docker 이미지의 데이터 관리 장치
  - Copy on Write
    - 어떤 데이터를 복사할 필요가 생겼을 때는 새로운 빈 영역을 확보하고 거기에 복사를 한다.
    - 만일 복사한 데이터에 변경이 없었다면 그 복사는 불필요한 것이 된다.
    - 복사한 데이터의 용량이 크면 클수록 쓸데없는 낭비가 발생한다.
    - 만일 바로 복사하지 않고 원래의 데이터를 그대로 참조시켜, 원본 또는 복사 중 한 쪽에 수정이 발생한 시점에 새로운 빈 영역을 확보하고 데이터를 복사한다면 이러한 낭비를 막을 수 있다.
    - 위와 같은 방식을 Copy on Write라고 부른다.
    - Docker는 Copy on Write 방식으로 컨테이너의 이미지를 관리한다.
  - AUFS
    - 다른 시스템의 파일이나 디렉토리를 투과적으로 겹쳐서 하나의 파일 트리를 구성할 수 있는 파일 시스템이다.
  - Btrfs
    - 리눅스용 Copy on Write 파일 시스템.
    - 과거의 상태로 돌아갈 수 있는 롤백 기능이나 어떤 시점에서의 상태를 저장할 수 있는 스냅샷 기능을 갖고 있다.
  - Device Mapper
    - 리눅스의 블록 디바이스 드라이버와 그것을 지원하는 라이브러리들이다.
    - 파일 시스템의 I/O와 디바이스의 매핑 관계를 관리한다.
  - OverlayFS
    - UnionFS 중 하나로, 파일 시스템에 다른 파일 시스템을 투과적으로 머징하는 장치이다.
  - ZFS
    - 볼륨 관리, 스냅샷, 체크섬 처리, 리플리케이션 등을 지원하는 파일 시스템. 



- Docker는 컨테이너를 독립된 공간으로 관리한다.
  - Docker는 하나의 Linux 커널을 여러 개의 컨테이너에서 공유하고 있다.
  - 컨테이너 안에서 작동하는 프로세스를 하나의 그룹으로 관리하고, 그룹마다 각각 파일 시스템이나 호스트명, 네트워크 등을 할당하고 있다.
  - 그룹이 다르면 프로세스나 파일에 대한 엑세스를 할 수 없다.
  - 이러한 구조를 활용하여 컨테이너를 독립된 공간으로 관리한다.